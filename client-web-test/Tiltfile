load("../projects/backend/common.Tiltfile", "backend")

ingress_enable = {
    ("%s.ingress.enabled" % s): "true"
    for s in ["attributes", "entitlements", "kas", "keycloak"]
}

backend(set=ingress_enable)

local_resource("test-client-web", "npm run test", resource_deps=["backend"])
CONTAINER_REGISTRY = os.environ.get("CONTAINER_REGISTRY", "ghcr.io")
docker_build(
    CONTAINER_REGISTRY + "/opentdf/abacus",
    "../projects/frontend",
    dockerfile="../projectsfrontend/DockerfileTests",
)
EXTERNAL_URL = "http://localhost:65432"
k8s_yaml(
    helm(
        "../projects/frontend/charts/abacus",
        "abacus",
        set=[
            "attributes.serverUrl=%s/api/attributes" % EXTERNAL_URL,
            "entitlements.serverUrl=%s/api/entitlements" % EXTERNAL_URL,
            "oidc.serverUrl=%s/auth/" % EXTERNAL_URL,
        ],
        values=["../client-web-test/frontend-values.yaml"],
    )
)
k8s_resource("abacus")

local_resource(
    "frontend-test",
    "CI=true npm run test:playwright",
    dir="../projects/frontend",
    resource_deps=["backend", "abacus"],
)
