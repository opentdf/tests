# Tiltfile for development of OpenTDF backend
# reference https://docs.tilt.dev/api.html
# extensions https://github.com/tilt-dev/tilt-extensions
# helm remote usage https://github.com/tilt-dev/tilt-extensions/tree/master/helm_remote#additional-parameters
load("ext://helm_resource", "helm_resource", "helm_repo")

load(
    "../projects/backend/common.Tiltfile",
    "CONTAINER_REGISTRY",
    "backend",
    "dict_to_helm_set_list",
)

EXTERNAL_URL = "http://localhost:65432"

ingress_enable = {
    ("%s.ingress.enabled" % s): "true"
    for s in ["attributes", "entitlements", "kas", "keycloak"]
}

backend(set=ingress_enable)

docker_build(CONTAINER_REGISTRY + "/opentdf/abacus", "../projects/frontend")
k8s_yaml(
    helm(
        "../projects/frontend/charts/abacus",
        set=[
            "attributes.serverUrl=%s/api/attributes" % EXTERNAL_URL,
            "entitlements.serverUrl=%s/api/entitlements" % EXTERNAL_URL,
            "oidc.serverUrl=%s/auth/" % EXTERNAL_URL,
            "ingress.enabled=false",
        ],
        values=["../client-web-test/frontend-values.yaml"],
    ),
)
k8s_resource("abacus", resource_deps=["backend"])

local_resource("test", "npm run test", resource_deps=["backend", "abacus"])
Build Failed: Internal error occurred: failed calling webhook "validate.nginx.ingress.kubernetes.io": failed to call webhook: Post "https://ingress-nginx-controller-admission.default.svc:443/networking/v1/ingresses?timeout=10s": x509: certificate signed by unknown authority
